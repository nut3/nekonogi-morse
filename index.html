<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>çŒ«èŠ’ãƒ¢ãƒ¼ãƒ«ã‚¹(Nekonogi Morse)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
</head>
<body>
<link rel="stylesheet" href="style.css">
<style>
textarea{
  width:30em;
  height:6em;
  padding:0;
  margin:0;
  border:1px solid red;
  font-size:16px;
}

#DebugText{
  height:30em;
  display:none;
}

button{
  width:30em;
  height:4em;
  padding:0;
  margin:0;
  border:1px solid blue;
  font-size:16px;
}
  
#HelpButton{
  height:2em;
}

#TwitterButton{
  width:30em;
  height:2em;
  display:block;
  color:white;
  background-color:RGB(29,161,242);
  text-decoration:none;
  text-align:center;
}
</style>
<h1>çŒ«èŠ’ãƒ¢ãƒ¼ãƒ«ã‚¹(Nekonogi Morse)</h1>
<div>
<button id="HelpButton">?</button>
</div>
<ul id="HelpText" style="display:none">
<li>
å¹³æ–‡ã«ä»¥ä¸‹ã®æ–‡å­—ã®ã¿å«ã‚€å ´åˆã€è‹±æ–‡ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚
<ul>
<li>A-Z</li>
<li>a-z</li>
<li>0-9</li>
<li>. , : ? _ + * - ^ / @ ( ) " '
</ul>
</li>
<li>ä»–ã®æ–‡å­—ã‚’å«ã‚€å ´åˆã€å’Œæ–‡ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚ï¼ˆæ—¥æœ¬èªä»¥å¤–ã®æ–‡å­—å«ã‚€ï¼‰</li>
<li>å’Œæ–‡ãƒ¢ãƒ¼ãƒ‰ã§å¤‰æ›ã§ãã‚‹ã®ã¯ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã§ã™ã€‚</li>
<li>ãã‚Œä»¥å¤–ã®æ–‡å­—ã¯ã™ã¹ã¦å˜èªåŒºåˆ‡ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚</li>
</ul>
</p>
<div>
<textarea id="PlainText"></textarea>
</div>
<div>
<button id="PlayNekonogi">ğŸ””çŒ«èŠ’ğŸ””</button>
</div>
<div id="MorseText" style="font-family:monospace;">
</div>
<div>
<textarea id="DebugText"></textarea>
</div>
<!--<a id="TwitterButton" href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-url="https://nut3.github.io/nekonogi-morse/" data-show-count="false">Tweet</a>-->
<a id="TwitterButton" href="http://twitter.com/share?url=https://nut3.github.io/nekonogi-morse/" target="_blank">Tweet</a>
<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script>
function getParam(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}


const morseMapEN = new Map([
   ['A','01'  ],['B','1000'],['C','1010'],['D','100' ],['E','0'   ]
  ,['F','0010'],['G','110' ],['H','0000'],['I','00'  ],['J','0111']
  ,['K','101' ],['L','0100'],['M','11'  ],['N','10'  ],['O','111' ]
  ,['P','0110'],['Q','1101'],['R','010' ],['S','000' ],['T','1'   ]
  ,['U','001' ],['V','0001'],['W','011' ],['X','1001'],['Y','1011']
  ,['Z','1100']
  
  ,['a','01'  ],['b','1000'],['c','1010'],['d','100' ],['e','0'   ]
  ,['f','0010'],['g','110' ],['h','0000'],['i','00'  ],['j','0111']
  ,['k','101' ],['l','0100'],['m','11'  ],['n','10'  ],['o','111' ]
  ,['p','0110'],['q','1101'],['r','010' ],['s','000' ],['t','1'   ]
  ,['u','001' ],['v','0001'],['w','011' ],['x','1001'],['y','1011']
  ,['z','1100']
  
  ,['1','01111' ],['2','00111' ],['3','00011' ],['4','00001' ],['5','00000' ]
  ,['6','10000' ],['7','11000' ],['8','11100' ],['9','11110' ],['0','11111' ]
  ,['.','010101'],[',','110011'],[':','111000'],['?','001100'],['_','001101']
  ,['+','01010' ],['-','100001'],['*','1001'  ],['^','000000'],['/','10010' ]
  ,['@','011010'],['(','10110' ],[')','101101'],['"','010010'],['\'','011110']
]);

function isEnglishText(plainText){
  for(i = 0 ; i < plainText.length ; ++i){
    const c = plainText[i];
    if(c ==' ' || morseMapEN.has(c)){
      continue;
    }
    return false;
  }
  return true;
}

const morseMapJA = new Map([
   ['ã‚¢','11011'      ],['ã‚¤','01'         ],['ã‚¦','001'        ],['ã‚¨','10111'      ],['ã‚ª','01000'      ]
  ,['ã‚«','0100'       ],['ã‚­','10100'      ],['ã‚¯','0001'       ],['ã‚±','1011'       ],['ã‚³','1111'       ]
  ,['ã‚µ','10101'      ],['ã‚·','11010'      ],['ã‚¹','11101'      ],['ã‚»','01110'      ],['ã‚½','1110'       ]
  ,['ã‚¿','10'         ],['ãƒ','0010'       ],['ãƒ„','0110'       ],['ãƒ†','01011'      ],['ãƒˆ','00100'      ]
  ,['ãƒŠ','010'        ],['ãƒ‹','1010'       ],['ãƒŒ','0000'       ],['ãƒ','1101'       ],['ãƒ','0011'       ]
  ,['ãƒ','1000'       ],['ãƒ’','11001'      ],['ãƒ•','1100'       ],['ãƒ˜','0'          ],['ãƒ›','100'        ]
  ,['ãƒ','1001'       ],['ãƒŸ','00101'      ],['ãƒ ','1'          ],['ãƒ¡','10001'      ],['ãƒ¢','10010'      ]
  ,['ãƒ¤','011'        ],['ãƒ¦','10011'      ],['ãƒ¨','11'         ]
  ,['ãƒ©','000'        ],['ãƒª','110'        ],['ãƒ«','10110'      ],['ãƒ¬','111'        ],['ãƒ­','0101'       ]
  ,['ãƒ¯','101'        ],['ãƒ²','0111'       ],['ãƒ³','01010'      ]

  ,['ã‚¡','11011'      ],['ã‚£','01'         ],['ã‚¥','001'        ],['ã‚§','10111'      ],['ã‚©','01000'      ]
  ,['ã‚¬','0100 00'    ],['ã‚®','10100 00'   ],['ã‚°','0001 00'    ],['ã‚²','1011 00'    ],['ã‚´','1111 00'    ]
  ,['ã‚¶','10101 00'   ],['ã‚¸','11010 00'   ],['ã‚º','11101 00'   ],['ã‚¼','01110 00'   ],['ã‚¾','1110 00'    ]
  ,['ãƒ€','10 00'      ],['ãƒ‚','0010 00'    ],['ãƒ…','0110 00'    ],['ãƒ‡','01011 00'   ],['ãƒ‰','00100 00'   ]
  ,['ãƒƒ','0110'       ]
  ,['ãƒ','1000 00'    ],['ãƒ“','11001 00'   ],['ãƒ–','1100 00'    ],['ãƒ™','0 00'       ],['ãƒœ','100 00'     ]
  ,['ãƒ‘','1000 00110' ],['ãƒ”','11001 00110'],['ãƒ—','1100 00110' ],['ãƒš','0 00110'    ],['ãƒ','100 00110'  ]
  ,['ãƒ£','011'        ],['ãƒ¥','10011'      ],['ãƒ§','11']
  ,['ãƒ°','01001'      ],['ãƒ±','01100'      ],['ãƒ´','001 00']

  ,['ã‚','11011'      ],['ã„','01'         ],['ã†','001'        ],['ãˆ','10111'      ],['ãŠ','01000'      ]
  ,['ã‹','0100'       ],['ã','10100'      ],['ã','0001'       ],['ã‘','1011'       ],['ã“','1111'       ]
  ,['ã•','10101'      ],['ã—','11010'      ],['ã™','11101'      ],['ã›','01110'      ],['ã','1110'       ]
  ,['ãŸ','10'         ],['ã¡','0010'       ],['ã¤','0110'       ],['ã¦','01011'      ],['ã¨','00100'      ]
  ,['ãª','010'        ],['ã«','1010'       ],['ã¬','0000'       ],['ã­','1101'       ],['ã®','0011'       ]
  ,['ã¯','1000'       ],['ã²','11001'      ],['ãµ','1100'       ],['ã¸','0'          ],['ã»','100'        ]
  ,['ã¾','1001'       ],['ã¿','00101'      ],['ã‚€','1'          ],['ã‚','10001'      ],['ã‚‚','10010'      ]
  ,['ã‚„','011'        ],['ã‚†','10011'      ],['ã‚ˆ','11'         ],['ã‚‰','000'        ],['ã‚Š','110'        ]
  ,['ã‚‹','10110'      ],['ã‚Œ','111'        ],['ã‚','0101'       ],['ã‚','101'        ],['ã‚’','0111'       ]
  ,['ã‚“','01010'      ]

  ,['ã','11011'      ],['ãƒ','01'         ],['ã…','001'        ],['ã‡','10111'      ],['ã‰','01000'      ]
  ,['ãŒ','0100 00'    ],['ã','10100 00'   ],['ã','0001 00'    ],['ã’','1011 00'    ],['ã”','1111 00'    ]
  ,['ã–','10101 00'   ],['ã˜','11010 00'   ],['ãš','11101 00'   ],['ãœ','01110 00'   ],['ã','1110 00'    ]
  ,['ã ','10 00'      ],['ã¢','0010 00'    ],['ã¥','0110 00'    ],['ã§','01011 00'   ],['ã©','00100 00'   ]
  ,['ã£','0110'       ]
  ,['ã°','1000 00'    ],['ã³','11001 00'   ],['ã¶','1100 00'    ],['ã¹','0 00'       ],['ã¼','100 00'     ]
  ,['ã±','1000 00110' ],['ã´','11001 00110'],['ã·','1100 00110' ],['ãº','0 00110'    ],['ã½','100 00110'  ]
  ,['ã‚ƒ','011'        ],['ã‚…','10011'      ],['ã‚‡','11'         ]
  
  ,['ã‚›','00'         ],['ã‚œ','00110'      ],['ãƒ¼','01101'      ],['ã€','010101'     ],['ï¼ˆ','101101'     ]
  ,['ï¼‰','010010'     ]
]);

const nekonogiTonLength = 4;
const nekonogiTsuLength = 4;

function toMorseText(plainText){
  var result="";
  var plainTextModeJA = !isEnglishText(plainText);
  var modeJA = plainTextModeJA;
  
  
  for (var i = 0 ; i < plainText.length ; ++i){
    var c = plainText[i];
    var m = '';
    if(morseMapEN.has(c)){
      //æ¬§æ–‡ãƒ¢ãƒ¼ãƒ«ã‚¹å¤‰æ›
      if(modeJA){
        m = '101101 ';
        modeJA = false;
      }
      m += morseMapEN.get(c);
    }else if(morseMapJA.has(c)){
      //å’Œæ–‡ãƒ¢ãƒ¼ãƒ«ã‚¹å¤‰æ›
      if(!modeJA){
        m = '010010 ';
        modeJA = true;
      }
      m += morseMapJA.get(c);
    }else{
     //ãã®ä»–ã®æ–‡å­—ã®å ´åˆã€å˜èªåŒºåˆ‡ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ã¿ãªã™
     m = '     ';
    }
    result += m.replace(/0/g,'ãƒ»').replace(/1/g,'â€') + ' ';
  }
  
  //å’Œæ–‡ã«å¯¾ã—ã¦è‹±æ–‡ãƒ¢ãƒ¼ãƒ‰ã§çµ‚ã‚ã£ãŸå ´åˆã¯çµ‚äº†ã®'ï¼‰'ã‚’ä»˜è¨˜ã™ã‚‹ã€‚
  if(!modeJA && plainTextModeJA){
    result += '010010 '.replace(/0/g,'ãƒ»').replace(/1/g,'â€');
  }
  
  result = result.replace(/\s/g,'â–¡');
  
  return result.length > 0 ? result.substring(0,result.length-1) : "";
};

/*é•·ç‚¹1ã¤ã¯çŸ­ç‚¹3ã¤åˆ†ã®é•·ã•ã«ç›¸å½“ã—ã€å„ç‚¹ã®é–“ã¯çŸ­ç‚¹1ã¤åˆ†ã®é–“éš”ã‚’ã‚ã‘ã‚‹ã€‚
ã¾ãŸã€æ–‡å­—é–“éš”ã¯çŸ­ç‚¹3ã¤åˆ†ã€èªé–“éš”ã¯çŸ­ç‚¹7ã¤åˆ†ã‚ã‘ã¦åŒºåˆ¥ã™ã‚‹ã€‚*/

function playNekonogi(morseCode){
  var v = [];
  for (let i = 0 ; i < morseCode.length ; ++i){
    var c = morseCode[i];
    if(c == 'ãƒ»'){
      var no = parseInt(Math.random()*nekonogiTonLength,10);
      v.push(new Audio("./ton"+no+".mp3"));
    }else if(c == 'â€'){
      var no = parseInt(Math.random()*nekonogiTsuLength,10);
      v.push(new Audio("./tsu"+no+".mp3"));
    }else{
      v.push(new Audio("./nosound.mp3"));
    }
    
    if(i > 0){
      v[i-1].addEventListener("ended", function(e){
        v[i].play();
        document.getElementById("M" + i).style.color = 'red';
      });
    }
  }
  if(v.length > 0){
    v.push(new Audio("./dayo.mp3"));
    v[v.length-2].addEventListener("ended", function(e){
      v[v.length-1].play();
      v[v.length-1].addEventListener("ended", function(e){
        document.getElementById("PlayNekonogi").disabled = false;
        var mi = document.getElementsByName("Mi");
        mi.forEach(function(o){o.style.color = 'black';});
      });
    });
    v[0].play();
    document.getElementById("M0").style.color = 'red';
    document.getElementById("PlayNekonogi").disabled = true;
  }
};

function taggedMorseText(morseCode){
  var result = "";
  for(var i = 0 ; i < morseCode.length ; ++i){
    result += "<span id='M" + i +"' class='Mi'>" + morseCode[i] + "</span>"
  }
  return result;
}

document.getElementById("PlayNekonogi").onclick = function() {
  var plainText = document.getElementById("PlainText").value;
  var morseText = toMorseText(plainText);
  document.getElementById("MorseText").innerHTML = taggedMorseText(morseText);
  playNekonogi(morseText);
  var shareURI = encodeURI(window.location.href.split(/[?#]/)[0] + "?t=" + plainText);
  document.getElementById("TwitterButton").href = "http://twitter.com/share?url=" + encodeURIComponent(shareURI) + "&text=çŒ«èŠ’ãƒ¢ãƒ¼ãƒ«ã‚¹(Nekonogi Morse)";
};

document.getElementById("HelpButton").onclick = function() {
  if(document.getElementById("HelpText").style.display == "none") {
    document.getElementById("HelpText").style.display = "block";
  }else{
    document.getElementById("HelpText").style.display = "none";
  }
}  
  
window.onload = function(){
  var paramT = getParam('t');
  if(paramT){
    document.getElementById("PlainText").value = paramT;
    document.getElementById("MorseText").value = toMorseText(paramT);
  }
  //if(getParam('p')){
  //  playNekonogi(document.getElementById("MorseText").value);
  //}
}

</script>
</body>
</html>
